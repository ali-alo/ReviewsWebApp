@using System.Security.Claims;
@using ReviewsWebApp.Areas.Identity;
@using System.Globalization;
@inject IViewLocalizer _localizer;
@model ReviewsIndexViewModel

@{
    ViewData["Title"] = _localizer["Title"];
    var currentCulture = CultureInfo.CurrentCulture;
    var cultureName = currentCulture.Name;

    bool CanEditReview(ReviewDetailsDto review) => 
        review.CreatorId is not null && review.CreatorId == @User.FindFirstValue(ClaimTypes.NameIdentifier)
        || User.IsInRole(ApplicationRoleTypes.Admin);
        string? userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
}

<h1>@_localizer["Header"]</h1>

<div class="row">
    @foreach(var review in Model.Reviews)
    {
        <div class="col-3 mt-4 d-flex">
            <div class="card">
                <img src="@(Model.ContainerLink +  (review.Images.Any() ? review.Images[0].ImageGuid : review.ReviewItemImageGuid))" class="img-clickable card-img-top h-200p" alt="Review image" />
                <div class="card-body d-flex flex-column">
                    <h5>
                        <a asp-action="Details" asp-controller="ReviewItem" asp-route-id="@review.ReviewItemId" class="text-decoration-none">
                            @(cultureName == "en" ? review.ReviewItemNameEn : review.ReviewItemNameRu)
                            <partial name="_ReviewGroupIcon" model="review.ReviewItemGroupNameEn" />
                        </a>
                    </h5>
                    <div class="ratings ratings-sm">
                        <span class="extra-info"><i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="@review.CreatorFirstName @review.CreatorLastName put @((int)Math.Floor(review.Grade)) stars for this item"></i></span>
                        @for (int i = 10; i >= 1; i--)
                        {
                            <span for="@i" @(review.Grade >= i ? "class=text-orange" : "")>&#9733</span>
                        }
                    </div>
                    <h5 class="card-title mt-2">@review.Title</h5>
                    <div class="card-text markdown mt-2">@review.MarkdownText</div>
                    <div class="text-end mt-auto">
                        <p class="mt-3 mb-0">
                            @if(review.CreatorFirstName == null)
                            {
                                <span>Deleted Account</span>
                            }
                            else
                            {
                                <a asp-action="Details" asp-controller="User" asp-route-id="@review.CreatorId">@($"{review.CreatorFirstName} {review.CreatorLastName}")</a>
                            }
                        </p>
                        <p><partial name="_ComputedCreatedTime" model="review.CreatedTime" /></p>
                    </div>
                    <div class="d-flex align-items-center">
                        <a asp-action="Details" asp-controller="Reviews" asp-route-id="@review.Id" class="btn btn-primary">Rate review</a>
                        @if (review.UsersIdWhoLiked.Contains(userId))
                        {
                            <a class="text-dark text-decoration-none ms-auto" href="@Url.Action("DislikeReview", "User", new { id = review.Id, returnUrl = $"/Reviews" })">
                                <i class="bi bi-heart-fill text-danger fs-3"></i>
                            </a>
                        }
                        else
                        {
                            <a class="text-dark text-decoration-none ms-auto" href="@Url.Action("LikeReview", "User", new { id = review.Id, returnUrl = $"/Reviews" })">
                                <i class="bi bi-heart-fill fs-3 "></i>
                            </a>
                        }
                        @if (CanEditReview(review))
                        {
                            <a asp-action="Edit" asp-controller="Reviews" asp-route-id="@review.Id" class="ms-2"><i class="bi bi-pencil text-danger fs-3"></i></a>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>